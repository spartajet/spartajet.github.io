<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="郭晓忠" />



<meta name="description" content="NJ4X 源码源码阅读分析第二次，nj4x-ts源码分析">
<meta name="keywords" content="NJ4X,源码分析">
<meta property="og:type" content="article">
<meta property="og:title" content="NJ4X源码阅读分析笔记系列（二）—— nj4x-ts初步分析">
<meta property="og:url" content="http://blog.spartajet.com/2017/05/20/2017-05-20-2/index.html">
<meta property="og:site_name" content="郭晓忠的博客">
<meta property="og:description" content="NJ4X 源码源码阅读分析第二次，nj4x-ts源码分析">
<meta property="og:image" content="http://ghost.guoxiaozhong.cn/ghost/2016-11-27-080124.jpg">
<meta property="og:image" content="http://ghost.guoxiaozhong.cn/ghost/2016-11-27-101946.jpg">
<meta property="og:image" content="http://ghost.guoxiaozhong.cn/ghost/2016-11-27-7992119353B363E037142B2886D5683C.png">
<meta property="og:image" content="http://ghost.guoxiaozhong.cn/ghost/2016-11-27-CD30BEFE6B52C7FDF5FB96790233A6FF.jpg">
<meta property="og:image" content="http://ghost.guoxiaozhong.cn/ghost/2016-11-27-E68934AFA757E833E14A31453BA7277A.png">
<meta property="og:image" content="http://ghost.guoxiaozhong.cn/ghost/2016-11-27-5C274ACCB46DC467C1F9095054644723.png">
<meta property="og:image" content="http://ghost.guoxiaozhong.cn/ghost/2016-11-27-122302.jpg">
<meta property="og:updated_time" content="2017-05-20T00:24:33.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="NJ4X源码阅读分析笔记系列（二）—— nj4x-ts初步分析">
<meta name="twitter:description" content="NJ4X 源码源码阅读分析第二次，nj4x-ts源码分析">
<meta name="twitter:image" content="http://ghost.guoxiaozhong.cn/ghost/2016-11-27-080124.jpg">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="郭晓忠的博客" type="application/atom+xml">



    <link rel="shortcut icon" href="/img/logo.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>NJ4X源码阅读分析笔记系列（二）—— nj4x-ts初步分析 | 郭晓忠的博客</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: undefined
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/logo.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">郭晓忠</a></h1>
        </hgroup>

        
        <p class="header-subtitle">机械男，程序员，前军校学员，穷逼博士。。。</p>
        

        


        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/随笔">随笔</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:spartajet.guo@gmail.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="https://github.com/spartajet" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa LinkedIn" href="https://www.linkedin.com/in/guoxiaozhong/" title="LinkedIn"></a>
                            
                                <a class="fa QQ" href="/1780273075" title="QQ"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                
                

                
                
                <section class="switch-part switch-part3">
                
                    <div id="js-aboutme">专注知识</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">郭晓忠</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/logo.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">郭晓忠</a></h1>
            </hgroup>
            
            <p class="header-subtitle">机械男，程序员，前军校学员，穷逼博士。。。</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/随笔">随笔</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:spartajet.guo@gmail.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/spartajet" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa LinkedIn" target="_blank" href="https://www.linkedin.com/in/guoxiaozhong/" title="LinkedIn"></a>
                            
                                <a class="fa QQ" target="_blank" href="/1780273075" title="QQ"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap"><article id="post-2017-05-20-2" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/20/2017-05-20-2/" class="article-date">
      <time datetime="2017-05-20T00:00:52.000Z" itemprop="datePublished">2017-05-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      NJ4X源码阅读分析笔记系列（二）—— nj4x-ts初步分析
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        

        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NJ4X/">NJ4X</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/源码分析/">源码分析</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>##nj4x-ts简介<br><strong>nj4x-ts</strong>是NJ4X项目中的终端服务器，参考我的上篇博客<a href="http://www.guoxiaozhong.cn/2016/11/27/nj4xyuan-ma-yue-du-fen-xi-bi-ji-xi-lie-yi-xiang-mu-zheng-ti-fen-xi/" target="_blank" rel="external">NJ4X源码阅读分析笔记系列（一）——项目整体分析</a>中的图：<br><img src="http://ghost.guoxiaozhong.cn/ghost/2016-11-27-080124.jpg" alt=""><br>方框中就是<strong>nj4x-ts</strong>的角色。</p>
<p><strong>nj4x-ts</strong>起着承上启下的作用，<strong>nj4x-ts</strong>提供了面向中断的网络通讯接口，操作底层的C++函数操作mt4的程序。然后让整个系统跑起来。</p>
<p>##包结构<br>包结构如图：<br><img src="http://ghost.guoxiaozhong.cn/ghost/2016-11-27-101946.jpg" alt=""><br>作用如下：</p>
<ul>
<li><strong>gui</strong> 界面</li>
<li><strong>io</strong> 引用dll库，文件操作</li>
<li><strong>jmx</strong> JMX服务器</li>
<li><strong>net</strong> 网络通讯相关</li>
<li><strong>xml</strong> xml操作类</li>
</ul>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>编译的时候，会出现问题，大致就是找不到dll，到时候要注意调整dll的路径，编译会直接生成课执行<code>jar</code>包，<code>exe</code>可执行程序程序，如下图：<br><img src="http://ghost.guoxiaozhong.cn/ghost/2016-11-27-7992119353B363E037142B2886D5683C.png" alt=""></p>
<p>其中<code>antrun</code>文件夹下是<code>ant</code>的编译脚本。</p>
<p>这样就编译完了整个项目。</p>
<p>##启动过程<br><strong>nj4x-ts</strong>的启动过程非常值得一提。</p>
<p>###入口函数<br>入口函数在<code>com.jfx.ts.net.TerminalServer</code>类中。</p>
<p>首先开始读取<code>main</code>函数的参数<code>args</code>，我们一般不给这个写参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">if (args.length % 2 == 0) &#123;</div><div class="line">                for (int i = 0; i &lt; args.length; i++) &#123;</div><div class="line">                    String pn = args[i++];</div><div class="line">                    String pv = args[i];</div><div class="line">                    System.setProperty(pn, pv);   //指定系统的全局属性</div><div class="line">                &#125;</div><div class="line">            &#125;</div></pre></td></tr></table></figure>
<p>然后加载dll库:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">LibrariesUtil.initEmbeddedLibraries();</div></pre></td></tr></table></figure>
<p><code>initEmbeddedLibraries()</code>加载dll之前，<code>LibrariesUtil</code>有一个静态块，静态块在构造函数之前运行，用以判断操作系统的位数，以及初始化程序的相关路径：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">static &#123;</div><div class="line">        String osName = System.getProperty(&quot;os.name&quot;);</div><div class="line">        isWindows = osName.toLowerCase().contains(&quot;windows&quot;);</div><div class="line">        String arch = System.getProperty(&quot;os.arch&quot;);</div><div class="line">        isX64 = arch.contains(&quot;amd64&quot;) || arch.contains(&quot;x64&quot;);</div><div class="line">        LIBS_DIR = System.getProperty(&quot;program_data_dir&quot;, &quot;C:\\ProgramData\\nj4x&quot;) + &quot;\\bin&quot;;</div><div class="line">//        LIBS_DIR = System.getProperty(&quot;user.dir&quot;);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>然后再调用<code>initEmbeddedLibraries()</code>函数，根据位数选择相应的dll。奇怪的是，作者并没有直接复制dll，而是直接二进制读取原路径的dll，然后在目标路径新建一个dll，把二进制写入新的dll文件，然后再<code>System.load()</code>，很奇怪，也许作者这样做是想确保每次的dll都是最新的。代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">final File libFile = new File(libFileName);   //     C:\ProgramData\nj4x\bin\PSUtils_x64.dll</div><div class="line">//</div><div class="line">final InputStream in = nativeLibraryUrl.openStream();</div><div class="line">final OutputStream out = new BufferedOutputStream(new FileOutputStream(libFile));</div><div class="line">//</div><div class="line">int len;</div><div class="line">byte[] buffer = new byte[160000];</div><div class="line">while ((len = in.read(buffer)) &gt; -1)</div><div class="line">    out.write(buffer, 0, len);  //写入dll文件</div><div class="line">out.close();</div><div class="line">in.close();</div><div class="line">//</div><div class="line">System.load(libFile.getAbsolutePath()); //加载PSUtil_X64.dll这个dll</div></pre></td></tr></table></figure>
<p>至此，dll加载完毕。</p>
<p>接下来就判断程序是不是以管理员身份登录的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">asAdministrator = PSUtils.asAdministrator();</div></pre></td></tr></table></figure>
<p>具体方法在<code>com.jfx.ts.io.PSUtils</code>中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public static boolean asAdministrator() &#123;</div><div class="line">    if (!isAdministrator()) &#123;</div><div class="line">        String compat_layer = System.getenv().get(&quot;__COMPAT_LAYER&quot;);</div><div class="line">        if (compat_layer == null || !compat_layer.contains(&quot;RunAsAdmin&quot;)) &#123;</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而<code>isAdministrator()</code>是一个<code>native</code>静态方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public static native boolean isAdministrator();</div></pre></td></tr></table></figure>
<p>这个方法是使用的<code>PSUtils_x64.dll</code>的native方法。因为<code>com.jfx.ts.io.PSUtils</code>中有一个静态块：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">// Load the dll that exports functions callable from java</div><div class="line">static &#123;</div><div class="line">    if (!LibrariesUtil.IS_OK) &#123;</div><div class="line">        String dllFileName = null;</div><div class="line">        try &#123;</div><div class="line">            if (LibrariesUtil.isX64) &#123;</div><div class="line">                dllFileName = &quot;PSUtils_x64.dll&quot;;</div><div class="line">            &#125; else &#123;</div><div class="line">                dllFileName = &quot;PSUtils.dll&quot;;</div><div class="line">            &#125;</div><div class="line">            String libFileName = LibrariesUtil.LIBS_DIR + File.separator + </div><div class="line">            System.load(libFileName);</div><div class="line">        &#125; catch (Throwable t) &#123;</div><div class="line">            t.printStackTrace();</div><div class="line">            try &#123;</div><div class="line">                System.load(dllFileName);</div><div class="line">            &#125; catch (Exception e) &#123;</div><div class="line">                System.exit(2);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>没错，这就是战斗民族的代码。</p>
<p>接下来就是确定最大线程数，不知道战斗民族为什么把代码写的如此复杂：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">//最大线程数，不知道为什么要搞得这么复杂</div><div class="line">           MAX_TERMINAL_STARTUP_THREADS = Integer.parseInt(System.getProperty(&quot;max_terminal_connection_threads&quot;, &quot;&quot; +</div><div class="line">                   (AVAILABLE_PROCESSORS &gt;= 24 ? AVAILABLE_PROCESSORS / 2</div><div class="line">                           : (AVAILABLE_PROCESSORS &gt;= 12 ? AVAILABLE_PROCESSORS / 3</div><div class="line">                           : (AVAILABLE_PROCESSORS &gt; 3 ? AVAILABLE_PROCESSORS - 2</div><div class="line">                           : AVAILABLE_PROCESSORS)))));</div></pre></td></tr></table></figure></p>
<p>然后判断，要不要启动专家系统，默认是不启动的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">IS_DEPLOY_EA_WS = System.getProperty(&quot;deploy_EA_WS&quot;, &quot;false&quot;).equals(&quot;true&quot;);</div></pre></td></tr></table></figure></p>
<p>作者在代码中大量的使用<code>System.getProperty()</code>方法操作参数，思路不错。</p>
<p>真正的部署程序在这个方面里面<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">deploy(port);</div></pre></td></tr></table></figure></p>
<p><code>deploy(port)</code>方法首先打印出所有的系统环境变量和程序设置的参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Logger logger = TS.LOGGER;</div><div class="line">//</div><div class="line">logger.info(&quot;--&quot;);</div><div class="line">logger.info(&quot;--&quot;);</div><div class="line">logger.info(&quot;--&quot;);</div><div class="line">logger.info(&quot;-- TS &quot; + TS.NJ4X + &quot; STARTUP --&quot;);</div><div class="line">logger.info(&quot;-- &quot; + TS.NJ4X_UUID + &quot; --&quot;);</div><div class="line">logger.info(&quot;--&quot;);</div><div class="line">logger.info(&quot;--&quot;);</div><div class="line">logger.info(&quot;--&quot;);</div><div class="line">logger.info(&quot;-- System properties --&quot;);</div><div class="line">for (Map.Entry e : new TreeMap&lt;&gt;(System.getProperties()).entrySet()) &#123;</div><div class="line">    logger.info(&quot;&quot; + e.getKey() + &quot;=&quot; + e.getValue());</div><div class="line">&#125;</div><div class="line">logger.info(&quot;-- Environment --&quot;);</div><div class="line">for (Map.Entry e : new TreeMap&lt;&gt;(System.getenv()).entrySet()) &#123;</div><div class="line">    logger.info(&quot;&quot; + e.getKey() + &quot;=&quot; + e.getValue());</div><div class="line">&#125;</div><div class="line">logger.info(&quot;-- Deployment --&quot;);</div></pre></td></tr></table></figure></p>
<p>然后实例化<code>TS</code>类，<code>TS</code>作用下一节再分析。</p>
<p>接下来就部署WebService服务，具体由<code>TsWS</code>类实现。</p>
<p>关于<strong>nj4x-ts</strong>的网络通信部分，会在下一篇博客中做介绍，在此略过。</p>
<p>但是作者在最后又默认启动专家系统的webserive，不知道为什么，现在没有计划研究专家系统，以后有可能。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//部署专家系统webservice</div><div class="line">deployEaWs(true);</div></pre></td></tr></table></figure></p>
<p>总之，启动后的样子：<br><img src="http://ghost.guoxiaozhong.cn/ghost/2016-11-27-CD30BEFE6B52C7FDF5FB96790233A6FF.jpg" alt=""></p>
<p>这个界面就不介绍了，懂的人自然懂。</p>
<h2 id="TS类的分析"><a href="#TS类的分析" class="headerlink" title="TS类的分析"></a><code>TS</code>类的分析</h2><p><code>TS</code>类要单独拿出来分析，因为，以上的启动过程都是表面上的，程序启动真正干活的是<code>TS</code>类。</p>
<p><code>TS</code>类中的各个静态变量，可以自己看。</p>
<p>首先，<code>TS</code>类有三个静态块：</p>
<p>第一个我不知道是干嘛用的,目的不明确：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">static &#123;</div><div class="line">    try &#123;</div><div class="line">        //不知道为什么要外部程序，不知道是干什么的，跑起来之后看看hostname是个什么鬼</div><div class="line">        //但是这个是简化外部当前JVM进程的执行。</div><div class="line">        ExternalProcess p = new ExternalProcess(&quot;hostname&quot;);</div><div class="line">        p.run();</div><div class="line">        TS.hostname = p.getOut().trim();</div><div class="line">    &#125; catch (Exception e) &#123;</div><div class="line">        TS.LOGGER.error(&quot;hostname cmd error&quot;, e);</div><div class="line">        TS.hostname = System.getenv(&quot;COMPUTERNAME&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>第二个初始化JFX的HOME路径：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">static &#123;</div><div class="line">    //貌似是初始化JFX的HOME路径</div><div class="line">    JFX_HOME = System.getProperty(&quot;home&quot;, System.getProperty(&quot;user.hom</div><div class="line">    System.setProperty(&quot;home&quot;, JFX_HOME);</div><div class="line">    String tmout = System.getenv(&quot;JFX_TERM_IDLE_TMOUT_SECONDS&quot;);</div><div class="line">    if (tmout == null) &#123;</div><div class="line">        JFX_TERM_IDLE_TMOUT_SECONDS = 3600 * 6;</div><div class="line">    &#125; else &#123;</div><div class="line">        JFX_TERM_IDLE_TMOUT_SECONDS = Long.parseLong(tmout);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>第三个非常重要，其作用是初始化程序运行的各种路径文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line">static &#123;</div><div class="line">    //mkdir函数，如果存在就返回false</div><div class="line">    new File(getTargetTermDir()).mkdirs();</div><div class="line">    //</div><div class="line">    new File(JFX_HOME_CONFIG).mkdirs();</div><div class="line">    new File(JFX_HOME_SRV_DIR).mkdirs();</div><div class="line">    new File(JFX_HOME_EA_DIR).mkdirs();</div><div class="line">    new File(JFX_HOME_EXPERTS_DIR).mkdirs();</div><div class="line">    new File(JFX_HOME_INDICATORS_DIR).mkdirs();</div><div class="line">    new File(JFX_HOME_CHR_DIR).mkdirs();</div><div class="line">    //</div><div class="line">    TerminalClient terminalClient = null;</div><div class="line">    try &#123;</div><div class="line">        terminalClient = new TerminalClient(&quot;127.0.0.1&quot;, Integer.parseInt(System.getProperty(&quot;port&quot;, &quot;7788&quot;)));</div><div class="line">        TS.P_GUI_ONLY = true;</div><div class="line">        if (!TS.P_USE_MSTSC) &#123;</div><div class="line">            String mode = terminalClient.ask(ClientWorkerThread.GETMODE).toLowerCase();</div><div class="line">            if (mode.contains(&quot;mstsc=true&quot;)) &#123;</div><div class="line">                TS.P_USE_MSTSC = true;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; catch (IOException e) &#123;</div><div class="line">        //ignore, seems this is 1st TS instance or port is used by another app</div><div class="line">    &#125; finally &#123;</div><div class="line">        if (terminalClient != null) &#123;</div><div class="line">            try &#123;</div><div class="line">                terminalClient.close();</div><div class="line">            &#125; catch (IOException ignore) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    //</div><div class="line">    LOGGING_CONFIG_XML = JFX_HOME_CONFIG + File.separatorChar + (P_GUI_ONLY ? &quot;gui_&quot; : &quot;&quot;) + &quot;logging.xml&quot;;</div><div class="line">    if (!new File(LOGGING_CONFIG_XML).exists()) &#123;</div><div class="line">        try &#123;</div><div class="line">            String loggingXml = ResourceReader.getClassResourceReader(TerminalServer.class, true).getProperty(&quot;logging.xml&quot;);</div><div class="line">            if (P_GUI_ONLY) &#123;</div><div class="line">                loggingXml = loggingXml.replace(&quot;jfx_term.log&quot;, &quot;gui_jfx_term.log&quot;);</div><div class="line">            &#125;</div><div class="line">            writeFile(LOGGING_CONFIG_XML, loggingXml.replace(&quot;./jfx_term/&quot;, JFX_HOME.replace(&apos;\\&apos;, &apos;/&apos;) + &quot;/&quot;).getBytes());</div><div class="line">        &#125; catch (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    //</div><div class="line">    if (!new File(JMX_CONFIG_XML).exists()) &#123;</div><div class="line">        try &#123;</div><div class="line">            writeFile(JMX_CONFIG_XML, ResourceReader.getClassResourceReader(TerminalServer.class).getProperty(&quot;mbean_config.xml&quot;).getBytes());</div><div class="line">        &#125; catch (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    //</div><div class="line">    DOMConfigurator.configureAndWatch(LOGGING_CONFIG_XML);</div><div class="line">    LOGGER = Logger.getLogger(TS.class);</div><div class="line">    //</div><div class="line">    String termDirLn = System.getenv(&quot;SystemDrive&quot;) + &quot;\\.&quot; + System.getProperty(&quot;port&quot;, &quot;7788&quot;);</div><div class="line">    File tmpDirLnk = new File(termDirLn);</div><div class="line">    if (tmpDirLnk.exists() &amp;&amp; !P_GUI_ONLY) &#123;</div><div class="line">        String linkDir = getLinkDir(tmpDirLnk);</div><div class="line">        if (linkDir == null || !new File(getTargetTermDir()).equals(new File(linkDir))) &#123;</div><div class="line">            tmpDirLnk.delete();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    if (!tmpDirLnk.exists()) &#123;</div><div class="line">        tmpDirLnk.delete();</div><div class="line">        ExternalProcess mklink = new ExternalProcess(&quot;cmd&quot;, &quot;/C&quot;, &quot;mklink&quot;, &quot;/J&quot;, termDirLn, getTargetTermDir());</div><div class="line">        try &#123;</div><div class="line">            mklink.run();</div><div class="line">            TERM_DIR = tmpDirLnk.exists() ? termDirLn : null;</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        TERM_DIR = termDirLn;</div><div class="line">    &#125;</div><div class="line">    //</div><div class="line">    tsConfig = new TSConfig();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>要注意几个路径：</p>
<p><code>C:\ProgramData\nj4x\bin</code>目前看来只包含<code>PSUtils_x64.dll</code>文件。</p>
<p><code>C:\Users\Micheal\jfx_term</code>文件夹比较复杂，总之就是包含了jfx所有的配置文件，如图：<br><img src="http://ghost.guoxiaozhong.cn/ghost/2016-11-27-E68934AFA757E833E14A31453BA7277A.png" alt=""><br><code>chr</code>文件夹是空的，不知道干嘛的。</p>
<p><code>config</code>文件夹中，是一些配置文件，<code>logging.xml</code>是<code>log4j</code>的配置文件。配置方式都不一样，战斗民族；<code>mbean-config.xml</code>文件是网络配置文件，下次博客再讲；<code>ts_config.xml</code>文件里面就有一句话，不知道什么意思：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;</div><div class="line">&lt;!DOCTYPE properties SYSTEM &quot;http://java.sun.com/dtd/properties.dtd&quot;&gt;</div><div class="line">&lt;properties&gt;</div><div class="line">&lt;comment&gt;Properties removed at Thu Nov 17 16:28:14 CST 2016&lt;/comment&gt;</div><div class="line">&lt;/properties&gt;</div></pre></td></tr></table></figure></p>
<p><code>log</code>文件夹中是日志。</p>
<p><code>srv</code>文件夹中是各个交易商的配置文件，这个和交易商有关：<br><img src="http://ghost.guoxiaozhong.cn/ghost/2016-11-27-5C274ACCB46DC467C1F9095054644723.png" alt=""></p>
<p><code>zero_term</code>文件夹中存放着一份<code>mt4</code>的程序。没有提到的文件夹就是空的。</p>
<p><code>C:\Users\Micheal\.jfx_terminals</code>这个文件夹中存放的是mt4的程序，每一个账号，每一个交易商的不同服务器都会创建一份新的程序，应该是配置文件不同。</p>
<p>##<code>TS.scheduledExecutorService</code>分析。</p>
<p>作者在<code>Ts</code>类中定义了一个<code>scheduledExecutorService</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">     * The constant scheduledExecutorService.</div><div class="line">     */</div><div class="line">    public static ScheduledExecutorService scheduledExecutorService</div><div class="line">            = java.util.concurrent.Executors.newScheduledThreadPool(64);</div></pre></td></tr></table></figure></p>
<p>据我统计，有<strong>10</strong>个地方用到了这个<code>scheduledExecutorService</code>，也就是至少有<strong>10</strong>个定时任务。</p>
<p>1.MT4程序连接监控，监控有没有网络连接到MT4程序。这个里面有两个，不知道为什么里面还有一个，这两个任务是一样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">if (mt4Module.isCheckRequired &amp;&amp; mt4Module.checkFuture == null) &#123;</div><div class="line">    mt4Module.checkFuture = scheduledExecutorService.schedule(new Runnable() &#123;</div><div class="line">        @Override</div><div class="line">        public void run() &#123;</div><div class="line">            Mt4Module mt4Module = incomingConnectionModule.get(tp.strategy);</div><div class="line">            if (mt4Module.isCheckRequired) &#123;</div><div class="line">                try &#123;</div><div class="line">                    String status = tp.checkTerminal(clientWorker);</div><div class="line">                    if (status.startsWith(&quot;OK&quot;)) &#123;</div><div class="line">                        mt4Module.checkFuture = scheduledExecutorService.schedule(this, 15, TimeUnit</div><div class="line">                    &#125; else &#123;</div><div class="line">                        mt4Module.checkFuture = null;</div><div class="line">                        incomingConnectionError.put(tp.strategy, status);</div><div class="line">                    &#125;</div><div class="line">                &#125; catch (NoSrvConnection e) &#123;</div><div class="line">                    String m = &quot;No connection to server: &quot; + e;</div><div class="line">                    TS.LOGGER.error(m, e);</div><div class="line">                    incomingConnectionError.put(tp.strategy, m);</div><div class="line">                &#125; catch (SrvFileNotFound e) &#123;</div><div class="line">                    String m = &quot;SRV file not found: &quot; + e;</div><div class="line">                    TS.LOGGER.error(m, e);</div><div class="line">                    incomingConnectionError.put(tp.strategy, m);</div><div class="line">                &#125; catch (MaxNumberOfTerminalsReached e) &#123;</div><div class="line">                    String m = &quot;Reached max number of terminals: &quot; + e;</div><div class="line">                    TS.LOGGER.error(m, e);</div><div class="line">                    incomingConnectionError.put(tp.strategy, m);</div><div class="line">                &#125; catch (InvalidUserNamePassword e) &#123;</div><div class="line">                    String m = &quot;Invalid user name or password: &quot; + e;</div><div class="line">                    TS.LOGGER.error(m, e);</div><div class="line">                    incomingConnectionError.put(tp.strategy, m);</div><div class="line">                &#125; catch (TerminalInstallationIsRequired e) &#123;</div><div class="line">                    String m = e.getMessage();</div><div class="line">                    TS.LOGGER.error(m, e);</div><div class="line">                    incomingConnectionError.put(tp.strategy, m);</div><div class="line">                &#125; catch (Throwable e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                    String m = &quot;Unexpected error: &quot; + e;</div><div class="line">                    TS.LOGGER.error(m, e);</div><div class="line">                    incomingConnectionError.put(tp.strategy, m);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;, 15, TimeUnit.SECONDS);</div></pre></td></tr></table></figure>
<p>2.磁盘监控，从这个就能看出对磁盘的操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">//这个磁盘监控每60s进行一次6</div><div class="line">spaceMonitoringJob =    scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123;</div><div class="line">    @Override</div><div class="line">    public void run() &#123;&#125;</div><div class="line">&#125;,5, 60, TimeUnit.SECONDS);</div></pre></td></tr></table></figure>
<p>3.监控新的session</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">TS.scheduledExecutorService.submit(newSessionCreator);</div></pre></td></tr></table></figure>
<p>4.监控终端变化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">TS.scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123;</div><div class="line">    public void run() &#123;</div><div class="line">        if (Log4JUtil.isConfigured() &amp;&amp; TS.LOGGER.isTraceEnabled()) &#123;</div><div class="line">            TS.LOGGER.trace(&quot;Timer: update session&apos;s load level&quot;);</div><div class="line">        &#125;</div><div class="line">        if (TS.P_USE_MSTSC) &#123;</div><div class="line">            try &#123;</div><div class="line">                loadExistingSessions();</div><div class="line">            &#125; catch (Throwable e) &#123;</div><div class="line">                TS.LOGGER.error(&quot;Error loading current sessions&quot;, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        updateTerminals();</div><div class="line">    &#125;</div><div class="line">&#125;, 30, 60, TimeUnit.SECONDS);</div></pre></td></tr></table></figure>
<p>4.监控google网盘设置变化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">TS.scheduledExecutorService.schedule(new Runnable() &#123;</div><div class="line">    @Override</div><div class="line">    public void run() &#123;</div><div class="line">        int nextSyncInSeconds = nextSyncInSeconds();</div><div class="line">        if (nextSyncInSeconds &gt; 0) &#123;</div><div class="line">            TS.scheduledExecutorService.schedule(this, 1/*Math.min(nextSyncInSeconds, 5)*/, TimeUnit.SECONDS);</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        try &#123;</div><div class="line">            checking = true;</div><div class="line">            boolean somethingDone = false;</div><div class="line">            for (DownloadSetup ds : downloads.values()) &#123;</div><div class="line">                somethingDone |= ds.run();</div><div class="line">            &#125;</div><div class="line">            if (somethingDone) &#123;</div><div class="line">                TS.LOGGER.info(&quot;Google Drive: All Downloads Complete!&quot;);</div><div class="line">            &#125;</div><div class="line">            checking = false;</div><div class="line">        &#125; finally &#123;</div><div class="line">            lastSyncTime = System.currentTimeMillis();</div><div class="line">            TS.scheduledExecutorService.schedule(this, 1/*Math.max(nextSyncInSeconds(), 5)*/, TimeUnit.SECONDS);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>5.日志压缩任务<br><img src="http://ghost.guoxiaozhong.cn/ghost/2016-11-27-122302.jpg" alt=""><br>6.断线终端的关闭任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">ScheduledFuture schedule = TS.scheduledExecutorService.schedule(new Runnable() &#123;</div><div class="line">    public void run() &#123;</div><div class="line">        if (Log4JUtil.isConfigured() &amp;&amp; TS.LOGGER.isInfoEnabled()) &#123;</div><div class="line">            TS.LOGGER.info(&quot;Timer: Stop terminal &quot; + processName);</div><div class="line">        &#125;</div><div class="line">        ts.killProcess(processName, true);</div><div class="line">    &#125;</div><div class="line">&#125;, TS.JFX_TERM_IDLE_TMOUT_SECONDS, TimeUnit.SECONDS);</div><div class="line">TS.terminations.put(processName, schedule);</div></pre></td></tr></table></figure>
<p>7.更新终端状态任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">TS.scheduledExecutorService.schedule(new Runnable() &#123;</div><div class="line">    public void run() &#123;</div><div class="line">        ts.updateTerminals();</div><div class="line">    &#125;</div><div class="line">&#125;, 2, TimeUnit.SECONDS);</div></pre></td></tr></table></figure>
<p>8.监控GUI中的网盘设置项变化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">TS.scheduledExecutorService.schedule(new Runnable() &#123;</div><div class="line">    @Override</div><div class="line">    public void run() &#123;</div><div class="line">        SwingUtilities.invokeLater(new Runnable() &#123;</div><div class="line">            @Override</div><div class="line">            public void run() &#123;</div><div class="line">                try &#123;</div><div class="line">                    if (!text.equals(updateInterval.getText())) &#123;</div><div class="line">                        return;</div><div class="line">                    &#125;</div><div class="line">                    if (text.replace(&quot;0&quot;, &quot;&quot;).length() &gt; 0) &#123;</div><div class="line">                        try &#123;</div><div class="line">                            if (Integer.parseInt(text) &lt;= 0) &#123;</div><div class="line">                                JOptionPane.showMessageDialog(null,</div><div class="line">                                        &quot;Error: Please enter number bigger than 0&quot;, &quot;Error Message&quot;,</div><div class="line">                                        JOptionPane.ERROR_MESSAGE);</div><div class="line">                            &#125; else &#123;</div><div class="line">                                TS.setConfigurationValue(&quot;cloud_update_interval&quot;, text);</div><div class="line">                                TS.LOGGER.info(&quot;Google Drive update interval set to &quot; + text + &quot; sec&quot;);</div><div class="line">                            &#125;</div><div class="line">                        &#125; catch (NumberFormatException e) &#123;</div><div class="line">                            JOptionPane.showMessageDialog(null,</div><div class="line">                                    &quot;Error: Please enter valid number &gt;0&quot;, &quot;Error Message&quot;,</div><div class="line">                                    JOptionPane.ERROR_MESSAGE);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125; catch (HeadlessException e) &#123;</div><div class="line">                    TS.LOGGER.error(&quot;At GUI&quot;, e);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;, KEY_PRESSED_ACTION_DELAY, TimeUnit.MILLISECONDS);</div></pre></td></tr></table></figure>
<p>9.貌似是界面的刷新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">TS.scheduledExecutorService.schedule(new Runnable() &#123;</div><div class="line">    @Override</div><div class="line">    public void run() &#123;</div><div class="line">        SwingUtilities.invokeLater(x);</div><div class="line">    &#125;</div><div class="line">&#125;, 1, TimeUnit.SECONDS);</div></pre></td></tr></table></figure>
<p>10.监控正在进行连接操作的终端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line">TS.scheduledExecutorService.schedule(new Runnable() &#123;</div><div class="line">    public void run() &#123;</div><div class="line">          将正在连接的终端列表下这个map</div><div class="line">        final HashMap&lt;String, TerminalParams&gt; tp = new HashMap&lt;&gt;();</div><div class="line">        synchronized (connectionsInProgress) &#123;</div><div class="line">            for (TerminalParams p : connectionsInProgress) &#123;</div><div class="line">                tp.put(p.getTerminalDirPathName(), p);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        SwingUtilities.invokeLater(new Runnable() &#123;</div><div class="line">            @Override</div><div class="line">            public void run() &#123;</div><div class="line">                try &#123;</div><div class="line">                    synchronized (connectionsInProgressTable) &#123;</div><div class="line">                        DefaultTableModel model = (DefaultTableModel) connectionsInProgressTable.getModel();</div><div class="line">                        Vector dataVector = model.getDataVector();</div><div class="line">                        int sz = dataVector.size();</div><div class="line">                        boolean allInPlace = sz &gt; 0;</div><div class="line">                        for (int row = 0; row &lt; sz; row++) &#123;</div><div class="line">                            String path = (String) model.getValueAt(row, model.findColumn(PATH_COLUMN));</div><div class="line">                            TerminalParams terminalParams = tp.get(path);</div><div class="line">                            if (terminalParams == null) &#123;</div><div class="line">                                allInPlace = false;</div><div class="line">                                break;</div><div class="line">                            &#125; else &#123;</div><div class="line">                                model.setValueAt(</div><div class="line">                                        //                                            &quot;&lt;html&gt;&lt;b&gt;&quot; + ((System.curre</div><div class="line">                                          设置连接的时间</div><div class="line">                                        new Integer((int) ((System.currentTimeMillis() - terminalParams.start.getT</div><div class="line">                                        row, model.findColumn(DURATION_COLUMN)</div><div class="line">                                );</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                          设置好时间之后开始显示</div><div class="line">                        if (!allInPlace) &#123;</div><div class="line">                            dataVector.clear();</div><div class="line">                            // new Object[]&#123;&quot;Broker&quot;, &quot;Account&quot;, &quot;Path&quot;, &quot;Start Time&quot;, &quot;Duration (s)&quot;&#125;</div><div class="line">                            for (Map.Entry&lt;String, TerminalParams&gt; p : tp.entrySet()) &#123;</div><div class="line">                                Vector row = new Vector();</div><div class="line">                                TerminalParams terminalParams = p.getValue();</div><div class="line">                                row.add(terminalParams.getSrv());</div><div class="line">                                row.add(terminalParams.getUser());</div><div class="line">                                row.add(new SimpleDateFormat(&quot;MMM d, HH:mm:ss&quot;).format(terminalParams.start));</div><div class="line">                                row.add(</div><div class="line">                                        //&quot;&lt;html&gt;&lt;b&gt;&quot; + ((System.currentTimeMillis() - terminalParams.start.getTim</div><div class="line">                                        new Integer((int) ((System.currentTimeMillis() - terminalParams.start.getT</div><div class="line">                                );</div><div class="line">                                row.add(terminalParams.getTerminalDirPathName());</div><div class="line">                                //</div><div class="line">                                dataVector.add(row);</div><div class="line">                            &#125;</div><div class="line">                            model.fireTableDataChanged();</div><div class="line">                        &#125;</div><div class="line">                        //这个才是真真的显示</div><div class="line">                        SwingUtilities.invokeLater(new Runnable() &#123;</div><div class="line">                            @Override</div><div class="line">                            public void run() &#123;</div><div class="line">                                try &#123;</div><div class="line">                                    TitledBorder border = (TitledBorder) connectionsInProgressPanel.getBorder();</div><div class="line">                                    border.setTitle(tp.size() &gt; 0</div><div class="line">                                            ? (tp.size() == 1 ? &quot;1 Connection In Progress&quot; : &quot;&quot; + tp.size() + &quot; Co</div><div class="line">                                            : &quot;Connections In Progress&quot;</div><div class="line">                                    );</div><div class="line">                                    connectionsInProgressPanel.repaint();</div><div class="line">                                &#125; catch (Exception e) &#123;</div><div class="line">                                    TS.LOGGER.error(&quot;At GUI&quot;, e);</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line">                &#125; catch (Exception e) &#123;</div><div class="line">                    TS.LOGGER.error(&quot;At GUI&quot;, e);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        //不知道这句话是干什么用的，为什么要this，this指的是这个new runable类，不知道加不加有什么区别</div><div class="line">        TS.scheduledExecutorService.schedule(this, 1, TimeUnit.SECONDS);</div><div class="line">    &#125;</div><div class="line">&#125;, 1, TimeUnit.SECONDS);</div></pre></td></tr></table></figure>
<p>11.监控日志显示列表的变化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">//监听日志限制输入框的输入变化</div><div class="line">TS.scheduledExecutorService.schedule(new Runnable() &#123;</div><div class="line">    @Override</div><div class="line">    public void run() &#123;</div><div class="line">        SwingUtilities.invokeLater(new Runnable() &#123;</div><div class="line">            @Override</div><div class="line">            public void run() &#123;</div><div class="line">                try &#123;</div><div class="line">                    if (!text.equals(limitRowsField.getText())) &#123;</div><div class="line">                        return;</div><div class="line">                    &#125;</div><div class="line">                    if (text.replace(&quot;0&quot;, &quot;&quot;).length() &gt; 0) &#123;</div><div class="line">                        try &#123;</div><div class="line">                            if (Integer.parseInt(text) &lt;= 0) &#123;</div><div class="line">                                JOptionPane.showMessageDialog(null,</div><div class="line">                                        &quot;Error: Please enter number bigger than 0&quot;, &quot;Error Message&quot;,</div><div class="line">                                        JOptionPane.ERROR_MESSAGE);</div><div class="line">                            &#125; else &#123;</div><div class="line">                                applyNewRowsLimit();</div><div class="line">                            &#125;</div><div class="line">                        &#125; catch (NumberFormatException e) &#123;</div><div class="line">                            JOptionPane.showMessageDialog(null,</div><div class="line">                                    &quot;Error: Please enter valid number bigger than 0&quot;, &quot;Error Message&quot;,</div><div class="line">                                    JOptionPane.ERROR_MESSAGE);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125; catch (HeadlessException e) &#123;</div><div class="line">                    TS.LOGGER.error(&quot;At GUI&quot;, e);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;, KEY_PRESSED_ACTION_DELAY, TimeUnit.MILLISECONDS);</div></pre></td></tr></table></figure>
<p><strong>此外，还有其他的任务，后面会提到</strong></p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2017/05/20/2017-05-20-2/">NJ4X源码阅读分析笔记系列（二）—— nj4x-ts初步分析</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">郭晓忠</a></p>
        <p><span>发布时间:</span>2017-05-20, 02:00:52</p>
        <p><span>最后更新:</span>2017-05-20, 02:24:33</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2017/05/20/2017-05-20-2/" title="NJ4X源码阅读分析笔记系列（二）—— nj4x-ts初步分析">http://blog.spartajet.com/2017/05/20/2017-05-20-2/</a>
            <span class="copy-path" data-clipboard-text="原文: http://blog.spartajet.com/2017/05/20/2017-05-20-2/　　作者: 郭晓忠" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2017/05/20/2017-05-20/">
                    Nginx 最全小白实战教程之三 （代理TCP篇）
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2017/05/20/javafx-spring-boot-maven/">
                    JavaFx+Springboot+Maven 开发打包教程
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#编译"><span class="toc-number">1.</span> <span class="toc-text">编译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TS类的分析"><span class="toc-number">2.</span> <span class="toc-text">TS类的分析</span></a></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"false"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"NJ4X源码阅读分析笔记系列（二）—— nj4x-ts初步分析　| 郭晓忠的博客　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    
        <section class="youyan" id="comments">
    <script>
        var loadComment = function(){
            var d = document, s = d.createElement('script');
            s.src = 'http://v2.uyan.cc/code/uyan.js?uid=2134017';
            (d.head || d.body).appendChild(s);
        }
    </script>
    
    <script> loadComment(); </script>

    <div id="uyan_frame"></div>
</section>
    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2017/05/20/2017-05-20/" title="上一篇: Nginx 最全小白实战教程之三 （代理TCP篇）">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2017/05/20/javafx-spring-boot-maven/" title="下一篇: JavaFx+Springboot+Maven 开发打包教程">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/06/01/2017-06-01/">时空复杂度</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/20/2017-05-20-1/">NJ4X源码阅读分析笔记系列（一）——项目整体分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/20/2017-05-20-3/">NJ4X源码阅读分析笔记系列（三）—— nj4x-ts深入分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/20/2017-05-20/">Nginx 最全小白实战教程之三 （代理TCP篇）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/20/2017-05-20-2/">NJ4X源码阅读分析笔记系列（二）—— nj4x-ts初步分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/20/javafx-spring-boot-maven/">JavaFx+Springboot+Maven 开发打包教程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/20/nginx-doc-02/">Nginx 最全小白实战教程之二 （代理篇）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/20/nginx-doc-01/">Nginx 最全小白实战教程之一 （安装篇）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/20/spring-boot-sharding-jdbc/">springboot+sharding-jdbc+mybatis+mysql全注解实现增量数据库分片实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/19/hello-world/">Hello World</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2017 郭晓忠
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>





    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>