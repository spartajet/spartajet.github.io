<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title><![CDATA[Nginx 最全小白实战教程之二 （代理篇）]]></title>
      <url>/2017/05/20/nginx-doc-02/</url>
      <content type="html"><![CDATA[<h2 id="一、相关概念"><a href="#一、相关概念" class="headerlink" title="一、相关概念"></a>一、相关概念</h2><p>代理一般分为正向代理和反向代理，以下是他们的定义(以下内容引自网上)</p>
<blockquote>
<p><strong>正向代理</strong>，也就是传说中的代理,他的工作原理就像一个跳板，简单的说，我是一个用户，我访问不了某网站，但是我能访问一个代理服务器，这个代理服务器呢，他能访问那个我不能访问的网站，于是我先连上代理服务器，告诉他我需要那个无法访问网站的内容，代理服务器去取回来，然后返回给我。从网站的角度，只在代理服务器来取内容的时候有一次记录，有时候并不知道是用户的请求，也隐藏了用户的资料，这取决于代理告不告诉网站。<br>结论就是，正向代理 是一个位于客户端和原始服务器(origin server)之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标(原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。客户端必须要进行一些特别的设置才能使用正向代理。</p>
<p><strong>反向代理</strong> 例如用户访问 <a href="http://www.test.com/readme" target="_blank" rel="external">http://www.test.com/readme</a> ，但www.test.com上并不存在readme页面，他是偷偷从另外一台服务器上取回来，然后作为自己的内容返回用户，但用户并不知情。这里所提到的 www.test.com 这个域名对应的服务器就设置了反向代理功能。<br>结论就是，反向代理正好相反，对于客户端而言它就像是原始服务器，并且客户端不需要进行任何特别的设置。客户端向反向代理的命名空间(name-space)中的内容发送普通请求，接着反向代理将判断向何处(原始服务器)转交请求，并将获得的内容返回给客户端，就像这些内容原本就是它自己的一样。</p>
</blockquote>
<p>两者区别就是：</p>
<ol>
<li>从<strong>用途</strong>上讲，正向代理的典型用途是为在防火墙内的局域网客户端提供访问Internet的途径。正向代理还可以使用缓冲特性减少网络使用率。反向代理的典型用途是将防火墙后面的服务器提供给Internet用户访问。反向代理还可以为后端的多台服务器提供负载平衡，或为后端较慢的服务器提供缓冲服务。另外，反向代理还可以启用高级URL策略和管理技术，从而使处于不同web服务器系统的web页面同时存在于同一个URL空间下。</li>
<li>从<strong>安全性</strong>讲，正向代理允许客户端通过它访问任意网站并且隐藏客户端自身，因此你必须采取安全措施以确保仅为经过授权的客户端提供服务。反向代理对外都是透明的，访问者并不知道自己访问的是一个代理。</li>
</ol>
<h2 id="二、Nginx代理"><a href="#二、Nginx代理" class="headerlink" title="二、Nginx代理"></a>二、Nginx代理</h2><h4 id="1-简单的代理"><a href="#1-简单的代理" class="headerlink" title="1.简单的代理"></a>1.简单的代理</h4><p>这样安装的配置文件位置在<code>/etc/nginx/conf.d</code>。其中有一个默认的配置文件<code>default.conf</code>，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen       80;</div><div class="line">    server_name  localhost;</div><div class="line"></div><div class="line">    #charset koi8-r;</div><div class="line">    #access_log  /var/log/nginx/log/host.access.log  main;</div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">        root   /usr/share/nginx/html;</div><div class="line">        index  index.html index.htm;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    #error_page  404              /404.html;</div><div class="line"></div><div class="line">    # redirect server error pages to the static page /50x.html</div><div class="line">    #</div><div class="line">    error_page   500 502 503 504  /50x.html;</div><div class="line">    location = /50x.html &#123;</div><div class="line">        root   /usr/share/nginx/html;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    # proxy the PHP scripts to Apache listening on 127.0.0.1:80</div><div class="line">    #</div><div class="line">    #location ~ \.php$ &#123;</div><div class="line">    #    proxy_pass   http://127.0.0.1;</div><div class="line">    #&#125;</div><div class="line"></div><div class="line">    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</div><div class="line">    #</div><div class="line">    #location ~ \.php$ &#123;</div><div class="line">    #    root           html;</div><div class="line">    #    fastcgi_pass   127.0.0.1:9000;</div><div class="line">    #    fastcgi_index  index.php;</div><div class="line">    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</div><div class="line">    #    include        fastcgi_params;</div><div class="line">    #&#125;</div><div class="line"></div><div class="line">    # deny access to .htaccess files, if Apache&apos;s document root</div><div class="line">    # concurs with nginx&apos;s one</div><div class="line">    #</div><div class="line">    #location ~ /\.ht &#123;</div><div class="line">    #    deny  all;</div><div class="line">    #&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这是一个比较全面的配置文件。且该目录下所有的<code>.conf</code>文件都会加载的，只要配置不冲突，所有的配置都会生效。</p>
<p>接下来在此目录新建<code>guo.conf</code>，将此域名访问代理我的个人博客 www.guoxiaozhong.cn。<br>具体内容如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen       80;</div><div class="line">    server_name  你的域名或者IP;  </div><div class="line">    location / &#123;</div><div class="line">        proxy_pass http://www.guoxiaozhong.cn;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>重新加载配置文件;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhost conf.d]# service nginx reload</div><div class="line">Reloading nginx:                                           [  OK  ]</div><div class="line">[root@localhost conf.d]# service nginx restart</div><div class="line">Stopping nginx:                                            [  OK  ]</div><div class="line">Starting nginx:                                            [  OK  ]</div></pre></td></tr></table></figure>
<p>访问效果如下：<br><img src="http://ghost.guoxiaozhong.cn/ghost/2017-01-03-030235.jpg" alt=""></p>
<p>目前的代理拓扑图为：<br><img src="http://ghost.guoxiaozhong.cn/ghost/2017-01-03-031823.jpg" alt=""></p>
<h4 id="2-指令说明"><a href="#2-指令说明" class="headerlink" title="2.指令说明"></a>2.指令说明</h4><p><strong>listen</strong>:要监听的端口，我们一般都是监听80端口，其他端口都封死，防火墙只剩80<br><strong>server_name</strong>：服务器的IP或者绑定的域名<br><strong>location /</strong>：这个是路径的意思，<code>/</code>这个是代表访问的路径，<code>/</code>代表根目录</p>
<p><strong>proxy_pass</strong>指令：</p>
<p>语法：proxyz_pass URL<br>默认值：no<br>使用字段：location，location中的if字段</p>
<p>这个指令设置被代理服务器的地址和被映射的URI，地址可以使用主机名或IP加端口号的形式，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">proxy_pass http://www.guoxiaozhong.cn;</div></pre></td></tr></table></figure>
<p><strong>注意</strong>：一定要写<code>http://</code></p>
<h4 id="3-分析日志"><a href="#3-分析日志" class="headerlink" title="3.分析日志"></a>3.分析日志</h4><h5 id="博客服务器的日志"><a href="#博客服务器的日志" class="headerlink" title="博客服务器的日志"></a>博客服务器的日志</h5><p>www.guoxiaozhong 博客服务器的日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Nginx服务器的IP - - [03/Jan/2017:10:49:19 +0800] &quot;GET /2016/11/29/office-2016-for-mac-de-wordmo-ban-wen-jian-jia-wei-zhi/ HTTP/1.0&quot; 200 4112 &quot;设置的代理域名&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 Safari/537.36&quot; &quot;-&quot;</div><div class="line">Nginx服务器的IP - - [03/Jan/2017:10:49:20 +0800] &quot;GET /content/images/2016/10/logo.jpeg HTTP/1.0&quot; 206 1 &quot;设置的代理域名&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 Safari/537.36&quot; &quot;-&quot;</div><div class="line">Nginx服务器的IP - - [03/Jan/2017:10:49:20 +0800] &quot;GET /content/images/2016/10/logo.jpeg HTTP/1.0&quot; 206 1778 &quot;设置的代理域名&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 Safari/537.36&quot; &quot;-&quot;</div><div class="line">Nginx服务器的IP - - [03/Jan/2017:10:49:21 +0800] &quot;GET /assets/images/favicon.png HTTP/1.0&quot; 200 2562 &quot;设置的代理域名&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 Safari/537.36&quot; &quot;-&quot;</div><div class="line">Nginx服务器的IP - - [03/Jan/2017:11:01:53 +0800] &quot;GET / HTTP/1.0&quot; 200 3951 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.95 Safari/537.36&quot; &quot;-&quot;</div><div class="line">Nginx服务器的IP - - [03/Jan/2017:11:01:53 +0800] &quot;GET /assets/css/vno.css?v=6d7f73f25e HTTP/1.0&quot; 200 4187 &quot;设置的代理域名&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.95 Safari/537.36&quot; &quot;-&quot;</div><div class="line">Nginx服务器的IP - - [03/Jan/2017:11:01:54 +0800] &quot;GET /assets/css/tomorrow.css?v=6d7f73f25e HTTP/1.0&quot; 200 610 &quot;http://xtrader.spartajet.com/&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.95 Safari/537.36&quot; &quot;-&quot;</div><div class="line">Nginx服务器的IP - - [03/Jan/2017:11:01:54 +0800] &quot;GET /assets/css/animate.css HTTP/1.0&quot; 200 5066 &quot;设置的代理域名&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.95 Safari/537.36&quot; &quot;-&quot;</div><div class="line">Nginx服务器的IP - - [03/Jan/2017:11:01:55 +0800] &quot;GET /assets/js/main.js?v=6d7f73f25e HTTP/1.0&quot; 200 662 &quot;设置的代理域名&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.95 Safari/537.36&quot; &quot;-&quot;</div><div class="line">Nginx服务器的IP - - [03/Jan/2017:11:01:55 +0800] &quot;GET /assets/js/highlight.pack.js?v=6d7f73f25e HTTP/1.0&quot; 200 15760 &quot;http://xtrader.spartajet.com/&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.95 Safari/537.36&quot; &quot;-&quot;</div></pre></td></tr></table></figure>
<p>可以看到，我的博客服务器上的日志只显示Nginx的IP和Nginx设置的域名，没有客户端的信息。</p>
<p>#####Nginx代理服务器的日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">客户端IP - - [03/Jan/2017:11:01:55 +0800] &quot;GET /assets/js/highlight.pack.js?v=6d7f73f25e HTTP/1.1&quot; 200 15788 &quot;设置的代理域名&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.95 Safari/537.36&quot; &quot;-&quot;</div><div class="line">客户端IP - - [03/Jan/2017:11:01:58 +0800] &quot;GET /content/images/2016/10/logo.jpeg HTTP/1.1&quot; 200 42960 &quot;设置的代理域名&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.95 Safari/537.36&quot; &quot;-&quot;</div><div class="line">客户端IP - - [03/Jan/2017:11:02:13 +0800] &quot;GET /content/images/2016/10/e69ef0aa357bd34022b2824daf3b5a33_r-1.jpg HTTP/1.1&quot; 200 176528 &quot;设置的代理域名&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.95 Safari/537.36&quot; &quot;-&quot;</div><div class="line">客户端IP - - [03/Jan/2017:11:02:16 +0800] &quot;GET /assets/images/favicon.png HTTP/1.1&quot; 200 2562 &quot;设置的代理域名&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.95 Safari/537.36&quot; &quot;-&quot;</div></pre></td></tr></table></figure>
<p>代理服务器上的日志显示客户端的IP。</p>
<h4 id="4-配置文件显示客户端IP"><a href="#4-配置文件显示客户端IP" class="headerlink" title="4.配置文件显示客户端IP"></a>4.配置文件显示客户端IP</h4><p>配置<code>guo.conf</code>文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen       80;</div><div class="line">    server_name  博客代理域名;</div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">        proxy_pass http://www.guoxiaozhong.cn;</div><div class="line">        proxy_set_header            X-real-ip $remote_addr;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>主要是加上;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">proxy_set_header            X-real-ip $remote_addr;</div></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> Nginx </tag>
            
            <tag> 代理 </tag>
            
            <tag> 教程 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Nginx 最全小白实战教程之一 （安装篇）]]></title>
      <url>/2017/05/20/nginx-doc-01/</url>
      <content type="html"><![CDATA[<h2 id="一、环境准备"><a href="#一、环境准备" class="headerlink" title="一、环境准备"></a>一、环境准备</h2><ol>
<li>操作系统：Centos6.4 64位</li>
<li>Nginx版本：1.4.2</li>
</ol>
<h2 id="二、安装Nginx"><a href="#二、安装Nginx" class="headerlink" title="二、安装Nginx"></a>二、安装Nginx</h2><h4 id="1-下载"><a href="#1-下载" class="headerlink" title="1.下载"></a>1.下载</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost nginx]# cd /usr/local/</div><div class="line">[root@localhost nginx]# mkdir nginx</div><div class="line">[root@localhost nginx]# cd nginx</div><div class="line">[root@localhost nginx]# wget http://nginx.org/download/nginx-1.4.2.tar.gz</div></pre></td></tr></table></figure>
<h4 id="2-解压"><a href="#2-解压" class="headerlink" title="2.解压"></a>2.解压</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost nginx]# tar xf nginx-1.4.2.tar.gz</div></pre></td></tr></table></figure>
<h4 id="3-新建Nginx用户与组"><a href="#3-新建Nginx用户与组" class="headerlink" title="3.新建Nginx用户与组"></a>3.新建Nginx用户与组</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhost nginx]# groupadd -g 108 -r nginx</div><div class="line">You have new mail in /var/spool/mail/root</div><div class="line">[root@localhost nginx]# useradd -u 108 -r -g 108 nginx</div><div class="line">[root@localhost nginx]# id nginx</div><div class="line">uid=108(nginx) gid=108(nginx) 组=108(nginx)</div></pre></td></tr></table></figure>
<h4 id="4-编译配置文件"><a href="#4-编译配置文件" class="headerlink" title="4.编译配置文件"></a>4.编译配置文件</h4><p>安装prce(重定向支持)和openssl(https支持，如果不需要https可以不安装。)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@localhost nginx]# yum install -y pcre-devel openssl-devel</div><div class="line">[root@localhost nginx]# cd  nginx-1.4.2</div><div class="line">[root@localhost nginx-1.4.2]# ./configure  \</div><div class="line">--prefix=/usr  \</div><div class="line">--sbin-path=/usr/sbin/nginx  \</div><div class="line">--conf-path=/etc/nginx/nginx.conf  \</div><div class="line">--error-log-path=/var/log/nginx/error.log  \</div><div class="line">--http-log-path=/var/log/nginx/access.log  \</div><div class="line">--pid-path=/var/run/nginx/nginx.pid  \</div><div class="line">--lock-path=/var/lock/nginx.lock \</div><div class="line">--user=nginx \</div><div class="line">--group=nginx \</div><div class="line">--with-http_ssl_module \</div><div class="line">--with-http_flv_module \</div><div class="line">--with-http_stub_status_module \</div><div class="line">--with-http_gzip_static_module \</div><div class="line">--http-client-body-temp-path=/var/tmp/nginx/client/ \</div><div class="line">--http-proxy-temp-path=/var/tmp/nginx/proxy/ \</div><div class="line">--http-fastcgi-temp-path=/var/tmp/nginx/fcgi/ \</div><div class="line">--http-uwsgi-temp-path=/var/tmp/nginx/uwsgi \</div><div class="line">--http-scgi-temp-path=/var/tmp/nginx/scgi \</div><div class="line">--with-pcre</div></pre></td></tr></table></figure>
<h4 id="5-编译并安装"><a href="#5-编译并安装" class="headerlink" title="5.编译并安装"></a>5.编译并安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost nginx-1.4.2]# make &amp;&amp; make install</div></pre></td></tr></table></figure>
<h4 id="6-初始化脚本"><a href="#6-初始化脚本" class="headerlink" title="6.初始化脚本"></a>6.初始化脚本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost nginx]# vi /etc/init.d/nginx</div></pre></td></tr></table></figure>
<p>脚本一定要写成这样，否则会出错的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div></pre></td><td class="code"><pre><div class="line">#!/bin/sh</div><div class="line">#</div><div class="line"># nginx        Startup script for nginx</div><div class="line">#</div><div class="line"># chkconfig: - 85 15</div><div class="line"># processname: nginx</div><div class="line"># config: /etc/nginx/nginx.conf</div><div class="line"># config: /etc/sysconfig/nginx</div><div class="line"># pidfile: /var/run/nginx.pid</div><div class="line"># description: nginx is an HTTP and reverse proxy server</div><div class="line">#</div><div class="line">### BEGIN INIT INFO</div><div class="line"># Provides: nginx</div><div class="line"># Required-Start: $local_fs $remote_fs $network</div><div class="line"># Required-Stop: $local_fs $remote_fs $network</div><div class="line"># Default-Start: 2 3 4 5</div><div class="line"># Default-Stop: 0 1 6</div><div class="line"># Short-Description: start and stop nginx</div><div class="line">### END INIT INFO</div><div class="line"></div><div class="line"># Source function library.</div><div class="line">. /etc/rc.d/init.d/functions</div><div class="line"></div><div class="line">if [ -L $0 ]; then</div><div class="line">    initscript=`/bin/readlink -f $0`</div><div class="line">else</div><div class="line">    initscript=$0</div><div class="line">fi</div><div class="line"></div><div class="line">sysconfig=`/bin/basename $initscript`</div><div class="line"></div><div class="line">if [ -f /etc/sysconfig/$sysconfig ]; then</div><div class="line">    . /etc/sysconfig/$sysconfig</div><div class="line">fi</div><div class="line"></div><div class="line">nginx=$&#123;NGINX-/usr/sbin/nginx&#125;</div><div class="line">prog=`/bin/basename $nginx`</div><div class="line">conffile=$&#123;CONFFILE-/etc/nginx/nginx.conf&#125;</div><div class="line">lockfile=$&#123;LOCKFILE-/var/lock/subsys/nginx&#125;</div><div class="line">pidfile=$&#123;PIDFILE-/var/run/nginx.pid&#125;</div><div class="line">SLEEPMSEC=$&#123;SLEEPMSEC-200000&#125;</div><div class="line">UPGRADEWAITLOOPS=$&#123;UPGRADEWAITLOOPS-5&#125;</div><div class="line">RETVAL=0</div><div class="line"></div><div class="line">start() &#123;</div><div class="line">    echo -n $&quot;Starting $prog: &quot;</div><div class="line"></div><div class="line">    daemon --pidfile=$&#123;pidfile&#125; $&#123;nginx&#125; -c $&#123;conffile&#125;</div><div class="line">    RETVAL=$?</div><div class="line">    echo</div><div class="line">    [ $RETVAL = 0 ] &amp;&amp; touch $&#123;lockfile&#125;</div><div class="line">    return $RETVAL</div><div class="line">&#125;</div><div class="line"></div><div class="line">stop() &#123;</div><div class="line">    echo -n $&quot;Stopping $prog: &quot;</div><div class="line">    killproc -p $&#123;pidfile&#125; $&#123;prog&#125;</div><div class="line">    RETVAL=$?</div><div class="line">    echo</div><div class="line">    [ $RETVAL = 0 ] &amp;&amp; rm -f $&#123;lockfile&#125; $&#123;pidfile&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">reload() &#123;</div><div class="line">    echo -n $&quot;Reloading $prog: &quot;</div><div class="line">    killproc -p $&#123;pidfile&#125; $&#123;prog&#125; -HUP</div><div class="line">    RETVAL=$?</div><div class="line">    echo</div><div class="line">&#125;</div><div class="line"></div><div class="line">upgrade() &#123;</div><div class="line">    oldbinpidfile=$&#123;pidfile&#125;.oldbin</div><div class="line"></div><div class="line">    configtest -q || return</div><div class="line">    echo -n $&quot;Starting new master $prog: &quot;</div><div class="line">    killproc -p $&#123;pidfile&#125; $&#123;prog&#125; -USR2</div><div class="line">    echo</div><div class="line"></div><div class="line">    for i in `/usr/bin/seq $UPGRADEWAITLOOPS`; do</div><div class="line">        /bin/usleep $SLEEPMSEC</div><div class="line">        if [ -f $&#123;oldbinpidfile&#125; -a -f $&#123;pidfile&#125; ]; then</div><div class="line">            echo -n $&quot;Graceful shutdown of old $prog: &quot;</div><div class="line">            killproc -p $&#123;oldbinpidfile&#125; $&#123;prog&#125; -QUIT</div><div class="line">            RETVAL=$?</div><div class="line">            echo</div><div class="line">            return</div><div class="line">        fi</div><div class="line">    done</div><div class="line"></div><div class="line">    echo $&quot;Upgrade failed!&quot;</div><div class="line">    RETVAL=1</div><div class="line">&#125;</div><div class="line"></div><div class="line">configtest() &#123;</div><div class="line">    if [ &quot;$#&quot; -ne 0 ] ; then</div><div class="line">        case &quot;$1&quot; in</div><div class="line">            -q)</div><div class="line">                FLAG=$1</div><div class="line">                ;;</div><div class="line">            *)</div><div class="line">                ;;</div><div class="line">        esac</div><div class="line">        shift</div><div class="line">    fi</div><div class="line">    $&#123;nginx&#125; -t -c $&#123;conffile&#125; $FLAG</div><div class="line">    RETVAL=$?</div><div class="line">    return $RETVAL</div><div class="line">&#125;</div><div class="line"></div><div class="line">rh_status() &#123;</div><div class="line">    status -p $&#123;pidfile&#125; -b $&#123;nginx&#125; $&#123;nginx&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"># See how we were called.</div><div class="line">case &quot;$1&quot; in</div><div class="line">    start)</div><div class="line">        rh_status &gt;/dev/null 2&gt;&amp;1 &amp;&amp; exit 0</div><div class="line">        start</div><div class="line">        ;;</div><div class="line">    stop)</div><div class="line">        stop</div><div class="line">        ;;</div><div class="line">    status)</div><div class="line">        rh_status</div><div class="line">        RETVAL=$?</div><div class="line">        ;;</div><div class="line">    restart)</div><div class="line">        configtest -q || exit $RETVAL</div><div class="line">        stop</div><div class="line">        start</div><div class="line">        ;;</div><div class="line">    upgrade)</div><div class="line">        rh_status &gt;/dev/null 2&gt;&amp;1 || exit 0</div><div class="line">        upgrade</div><div class="line">        ;;</div><div class="line">    condrestart|try-restart)</div><div class="line">        if rh_status &gt;/dev/null 2&gt;&amp;1; then</div><div class="line">            stop</div><div class="line">            start</div><div class="line">        fi</div><div class="line">        ;;</div><div class="line">    force-reload|reload)</div><div class="line">        reload</div><div class="line">        ;;</div><div class="line">    configtest)</div><div class="line">        configtest</div><div class="line">        ;;</div><div class="line">    *)</div><div class="line">        echo $&quot;Usage: $prog &#123;start|stop|restart|condrestart|try-restart|force-reload|upgrade|reload|status|help|configtest&#125;&quot;</div><div class="line">        RETVAL=2</div><div class="line">esac</div><div class="line"></div><div class="line">exit $RETVAL</div></pre></td></tr></table></figure>
<p>脚本处理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost init.d]# chmod +x nginx</div><div class="line">[root@localhost init.d]# chkconfig --add nginx</div><div class="line">[root@localhost init.d]# chkconfig nginx on</div><div class="line">[root@localhost init.d]# service nginx start</div></pre></td></tr></table></figure>
<p>然后访问：<br><img src="http://ghost.guoxiaozhong.cn/ghost/2017-01-02-145323.jpg" alt=""></p>
<h2 id="三、yum安装nginx"><a href="#三、yum安装nginx" class="headerlink" title="三、yum安装nginx"></a>三、yum安装nginx</h2><p><strong>推荐使用这种方法，上一种方法折腾了一晚上呢</strong>，之后的教程以此方法为主</p>
<h4 id="1-增加Nginx仓储地址"><a href="#1-增加Nginx仓储地址" class="headerlink" title="1.增加Nginx仓储地址"></a>1.增加Nginx仓储地址</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]# vi /etc/yum.repos.d/nginx.repo</div></pre></td></tr></table></figure>
<p>在文件中写入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[nginx] </div><div class="line">name=nginx repo  </div><div class="line">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/  </div><div class="line">gpgcheck=0  </div><div class="line">enabled=1</div></pre></td></tr></table></figure>
<p>然后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]# sudo yum install nginx -y </div><div class="line">[root@localhost ~]# sudo service nginx start</div><div class="line">[root@localhost ~]# sudo chkconfig nginx on</div></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> Nginx </tag>
            
            <tag> 教程 </tag>
            
            <tag> 安装 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[springboot+sharding-jdbc+mybatis+mysql全注解实现增量数据库分片实现]]></title>
      <url>/2017/05/20/spring-boot-sharding-jdbc/</url>
      <content type="html"><![CDATA[<blockquote>
<p>项目中遇到了分库分表的问题，找到了shrding-jdbc，于是就搞了一个springboot+sharding-jdbc+mybatis的增量分片的应用。今天写博客总结一下遇到的坑。</p>
<p>其实，我自己写了一个increament-jdbc组件的，当我读了sharding-jdbc的源码之后，发现思路和原理差不多，sharding这个各方面要比我的强，毕竟我是一天之内赶出来的东东。</p>
<p>示例代码地址:<a href="http://git.oschina.net/qcwz/springboot-sharding-jdbc-demo" target="_blank" rel="external">http://git.oschina.net/qcwz/springboot-sharding-jdbc-demo</a></p>
<p>demo没有写日志，也没有各种异常判断，只是说明问题</p>
</blockquote>
<h2 id="一、需求背景"><a href="#一、需求背景" class="headerlink" title="一、需求背景"></a>一、需求背景</h2><p>我的项目背景就不说了，现在举一个例子吧：A,B两支股票都在上海，深圳上市，需要实时记录这两支股票的交易tick(不懂tick也没有关系)。现在的分片策略是：上海、深圳分别建库，每个库都存各自交易所的两支股票的ticktick，且按照月分表。如图：</p>
<ul>
<li>db_sh<ul>
<li>tick_a_2017_01</li>
<li>tick_b_2017_01</li>
<li>……..</li>
<li>tick_a_2017_12</li>
<li>tick_b_2017_12</li>
</ul>
</li>
<li><p>db_sz</p>
<ul>
<li><p>tick_a_2017_01</p>
<ul>
<li>tick_b_2017_01</li>
<li>……..</li>
<li>tick_a_2017_12</li>
<li>tick_b_2017_12</li>
</ul>
<p>分库分表就是这样的。根据这个建库。</p>
<p><strong>千万不要讨论这样分库分表是否合适，这里这样分片只是举个栗子，说明分库分表这个事情。</strong></p>
<p><strong>Sharding-jdbc是不支持建库的SQL，如果像我这样增量的数据库和数据表，那就要一次性把一段时期的数据库和数据表都要建好。</strong></p>
</li>
</ul>
</li>
</ul>
<h2 id="二、建库"><a href="#二、建库" class="headerlink" title="二、建库"></a>二、建库</h2><p>考虑到表确实多，所以我就只建1，2月份的表。语句见demo文件。</p>
<h2 id="三、springboot集成sharding-jdbc"><a href="#三、springboot集成sharding-jdbc" class="headerlink" title="三、springboot集成sharding-jdbc"></a>三、springboot集成sharding-jdbc</h2><p>mvn配置pom如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spartajet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springboot-sharding-jdbc-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>springboot-sharding-jdbc-demo<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">description</span>&gt;</span>Springboot integrate Sharding-jdbc Demo<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">project.build.locales</span>&gt;</span>zh_CN<span class="tag">&lt;/<span class="name">project.build.locales</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">project.build.jdk</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">project.build.jdk</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">spring.boot.version</span>&gt;</span>1.4.1.RELEASE<span class="tag">&lt;/<span class="name">spring.boot.version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">com.alibaba.druid.version</span>&gt;</span>1.0.13<span class="tag">&lt;/<span class="name">com.alibaba.druid.version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">mysql-connector-java.version</span>&gt;</span>5.1.36<span class="tag">&lt;/<span class="name">mysql-connector-java.version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">sharding-jdbc.version</span>&gt;</span>1.4.1<span class="tag">&lt;/<span class="name">sharding-jdbc.version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">com.google.code.gson.version</span>&gt;</span>2.8.0<span class="tag">&lt;/<span class="name">com.google.code.gson.version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">joda-trade.version</span>&gt;</span>2.9.7<span class="tag">&lt;/<span class="name">joda-trade.version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">commons-dbcp.version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">commons-dbcp.version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">commons-io.version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">commons-io.version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">mybatis-spring-boot-starter.version</span>&gt;</span>1.2.0<span class="tag">&lt;/<span class="name">mybatis-spring-boot-starter.version</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis-spring-boot-starter.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-dbcp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-dbcp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;commons-dbcp.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dangdang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding-jdbc.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dangdang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-config-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding-jdbc.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dangdang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-self-id-generator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding-jdbc.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.code.gson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;com.google.code.gson.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>spring-boot-start-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>spring-boot-start-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-over-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mysql-connector-java.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">source</span>&gt;</span>$&#123;project.build.jdk&#125;<span class="tag">&lt;/<span class="name">source</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">target</span>&gt;</span>$&#123;project.build.jdk&#125;<span class="tag">&lt;/<span class="name">target</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">encoding</span>&gt;</span>$&#123;project.build.sourceEncoding&#125;<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">build</span>&gt;</span></div></pre></td></tr></table></figure>
<p>其实这个和sharding-jdbc的官网差不多。其实我想写一个<code>sharding-jdbc-spring-boot-starter</code>的pom的，等项目业务都做完再说吧。</p>
<h2 id="四、配置数据源"><a href="#四、配置数据源" class="headerlink" title="四、配置数据源"></a>四、配置数据源</h2><p>我想将数据库做成可配置的，所以我没有在<code>application.properties</code>文件中直接配置数据库，而是写在了<code>database.json</code>文件中。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"name"</span>: <span class="string">"db_sh"</span>,</div><div class="line">    <span class="attr">"url"</span>: <span class="string">"jdbc:mysql://localhost:3306/db_sh"</span>,</div><div class="line">    <span class="attr">"username"</span>: <span class="string">"root"</span>,</div><div class="line">    <span class="attr">"password"</span>: <span class="string">"root"</span>,</div><div class="line">    <span class="attr">"driveClassName"</span>:<span class="string">"com.mysql.jdbc.Driver"</span></div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"name"</span>: <span class="string">"db_sz"</span>,</div><div class="line">    <span class="attr">"url"</span>: <span class="string">"jdbc:mysql://localhost:3306/db_sz"</span>,</div><div class="line">    <span class="attr">"username"</span>: <span class="string">"root"</span>,</div><div class="line">    <span class="attr">"password"</span>: <span class="string">"root"</span>,</div><div class="line">    <span class="attr">"driveClassName"</span>:<span class="string">"com.mysql.jdbc.Driver"</span></div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<p>然后在springboot读取database文件，加载方式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Value</span>(<span class="string">"classpath:database.json"</span>)</div><div class="line">    <span class="keyword">private</span> Resource databaseFile;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;Database&gt; <span class="title">databases</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        String databasesString = IOUtils.toString(databaseFile.getInputStream(), Charset.forName(<span class="string">"UTF-8"</span>));</div><div class="line">        List&lt;Database&gt; databases = <span class="keyword">new</span> Gson().fromJson(databasesString, <span class="keyword">new</span> TypeToken&lt;List&lt;Database&gt;&gt;() &#123;</div><div class="line">        &#125;.getType());</div><div class="line">        <span class="keyword">return</span> databases;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>加载完database信息之后，可以通过工厂方法配置逻辑数据库：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function"><span class="keyword">public</span> HashMap&lt;String, DataSource&gt; <span class="title">dataSourceMap</span><span class="params">(List&lt;Database&gt; databases)</span> </span>&#123;</div><div class="line">    Map&lt;String, DataSource&gt; dataSourceMap = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    <span class="keyword">for</span> (Database database : databases) &#123;</div><div class="line">        DataSourceBuilder dataSourceBuilder = DataSourceBuilder.create();</div><div class="line">        dataSourceBuilder.url(database.getUrl());</div><div class="line">        dataSourceBuilder.driverClassName(database.getDriveClassName());</div><div class="line">        dataSourceBuilder.username(database.getUsername());</div><div class="line">        dataSourceBuilder.password(database.getPassword());</div><div class="line">        DataSource dataSource = dataSourceBuilder.build();</div><div class="line">        dataSourceMap.put(database.getName(), dataSource);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> dataSourceMap;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样就把各个逻辑数据库就加载好了。</p>
<h2 id="五、配置分片策略"><a href="#五、配置分片策略" class="headerlink" title="五、配置分片策略"></a>五、配置分片策略</h2><h3 id="5-1数据库分片策略"><a href="#5-1数据库分片策略" class="headerlink" title="5.1数据库分片策略"></a>5.1数据库分片策略</h3><p>在这个实例中，数据库的分库就是根据上海(sh)和深圳(sz)来分的，在sharding-jdbc中是单键分片。根据官方文档实现接口<code>SingleKeyDatabaseShardingAlgorithm</code>就可以</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DatabaseShardingAlgorithm</span> <span class="keyword">implements</span> <span class="title">SingleKeyDatabaseShardingAlgorithm</span>&lt;<span class="title">String</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 根据分片值和SQL的=运算符计算分片结果名称集合.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> availableTargetNames 所有的可用目标名称集合, 一般是数据源或表名称</div><div class="line">     * <span class="doctag">@param</span> shardingValue        分片值</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> 分片后指向的目标名称, 一般是数据源或表名称</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doEqualSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, ShardingValue&lt;String&gt; shardingValue)</span> </span>&#123;</div><div class="line">        String databaseName = <span class="string">""</span>;</div><div class="line">        <span class="keyword">for</span> (String targetName : availableTargetNames) &#123;</div><div class="line">            <span class="keyword">if</span> (targetName.endsWith(shardingValue.getValue())) &#123;</div><div class="line">                databaseName = targetName;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> databaseName;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>此接口还有另外两个方法，<code>doInSharding</code>和<code>doBetweenSharding</code>，因为我暂时不用IN和BETWEEN方法，所以就没有写，直接返回null。</p>
<h3 id="5-2数据表分片策略"><a href="#5-2数据表分片策略" class="headerlink" title="5.2数据表分片策略"></a>5.2数据表分片策略</h3><p>数据表的分片策略是根据股票和时间共同决定的，在sharding-jdbc中是多键分片。根据官方文档，实现<code>MultipleKeysTableShardingAlgorithm</code>接口就OK了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TableShardingAlgorithm</span> <span class="keyword">implements</span> <span class="title">MultipleKeysTableShardingAlgorithm</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 根据分片值计算分片结果名称集合.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> availableTargetNames 所有的可用目标名称集合, 一般是数据源或表名称</div><div class="line">     * <span class="doctag">@param</span> shardingValues       分片值集合</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> 分片后指向的目标名称集合, 一般是数据源或表名称</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, Collection&lt;ShardingValue&lt;?&gt;&gt; shardingValues)</span> </span>&#123;</div><div class="line">        String name = <span class="keyword">null</span>;</div><div class="line">        Date time = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">for</span> (ShardingValue&lt;?&gt; shardingValue : shardingValues) &#123;</div><div class="line">            <span class="keyword">if</span> (shardingValue.getColumnName().equals(<span class="string">"name"</span>)) &#123;</div><div class="line">                name = ((ShardingValue&lt;String&gt;) shardingValue).getValue();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (shardingValue.getColumnName().equals(<span class="string">"time"</span>)) &#123;</div><div class="line">                time = ((ShardingValue&lt;Date&gt;) shardingValue).getValue();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (name != <span class="keyword">null</span> &amp;&amp; time != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        String timeString = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy_MM"</span>).format(time);</div><div class="line">        String suffix = name + <span class="string">"_"</span> + timeString;</div><div class="line">        Collection&lt;String&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (String targetName : availableTargetNames) &#123;</div><div class="line">            <span class="keyword">if</span> (targetName.endsWith(suffix)) &#123;</div><div class="line">                result.add(targetName);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这些方法的使用可以查官方文档。</p>
<h3 id="5-3注入分片策略"><a href="#5-3注入分片策略" class="headerlink" title="5.3注入分片策略"></a>5.3注入分片策略</h3><p>以上只是定义了分片算法，还没有形成策略，还没有告诉shrding将哪个字段给分片算法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">@Configuration</div><div class="line">public class ShardingStrategyConfig &#123;</div><div class="line">    @Bean</div><div class="line">    public DatabaseShardingStrategy databaseShardingStrategy(DatabaseShardingAlgorithm databaseShardingAlgorithm) &#123;</div><div class="line">        DatabaseShardingStrategy databaseShardingStrategy = new DatabaseShardingStrategy(&quot;exchange&quot;, databaseShardingAlgorithm);</div><div class="line">        return databaseShardingStrategy;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Bean</div><div class="line">    public TableShardingStrategy tableShardingStrategy(TableShardingAlgorithm tableShardingAlgorithm) &#123;</div><div class="line">        Collection&lt;String&gt; columns = new LinkedList&lt;&gt;();</div><div class="line">        columns.add(&quot;name&quot;);</div><div class="line">        columns.add(&quot;time&quot;);</div><div class="line">        TableShardingStrategy tableShardingStrategy = new TableShardingStrategy(columns, tableShardingAlgorithm);</div><div class="line">        return tableShardingStrategy;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样才能形成完成的分片策略。</p>
<h2 id="六、配置Sharding-jdbc的DataSource"><a href="#六、配置Sharding-jdbc的DataSource" class="headerlink" title="六、配置Sharding-jdbc的DataSource"></a>六、配置Sharding-jdbc的DataSource</h2><p>sharding-jdbc的原理其实很简单，就是自己做一个DataSource给上层应用使用，这个DataSource包含所有的逻辑库和逻辑表，应用增删改查时，他自己再修改sql，然后选择合适的数据库继续操作。所以这个DataSource创建很重要。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="meta">@Primary</span></div><div class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">shardingDataSource</span><span class="params">(HashMap&lt;String, DataSource&gt; dataSourceMap, DatabaseShardingStrategy databaseShardingStrategy, TableShardingStrategy tableShardingStrategy)</span> </span>&#123;</div><div class="line">    DataSourceRule dataSourceRule = <span class="keyword">new</span> DataSourceRule(dataSourceMap);</div><div class="line">    TableRule tableRule = TableRule.builder(<span class="string">"tick"</span>).actualTables(Arrays.asList(<span class="string">"db_sh.tick_a_2017_01"</span>, <span class="string">"db_sh.tick_a_2017_02"</span>, <span class="string">"db_sh.tick_b_2017_01"</span>, <span class="string">"db_sh.tick_b_2017_02"</span>, <span class="string">"db_sz.tick_a_2017_01"</span>, <span class="string">"db_sz.tick_a_2017_02"</span>, <span class="string">"db_sz.tick_b_2017_01"</span>, <span class="string">"db_sz.tick_a_2017_02"</span>)).dataSourceRule(dataSourceRule).build();</div><div class="line">    ShardingRule shardingRule = ShardingRule.builder().dataSourceRule(dataSourceRule).tableRules(Arrays.asList(tableRule)).databaseShardingStrategy(databaseShardingStrategy).tableShardingStrategy(tableShardingStrategy).build();</div><div class="line">    DataSource shardingDataSource = ShardingDataSourceFactory.createDataSource(shardingRule);</div><div class="line">    <span class="keyword">return</span> shardingDataSource;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>这里要着重说一下为什么要用@Primary这个注解，没有这个注解是会报错的，错误大致意思就是DataSource太多了，mybatis不知道用哪个。加上这个mybatis就知道用sharding的DataSource了。这里参考的是jpa的多数据源配置</strong></p>
<h2 id="七、配置mybatis"><a href="#七、配置mybatis" class="headerlink" title="七、配置mybatis"></a>七、配置mybatis</h2><h3 id="7-1-Bean"><a href="#7-1-Bean" class="headerlink" title="7.1 Bean"></a>7.1 Bean</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tick</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> String exchange;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> ask;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> bid;</div><div class="line">    <span class="keyword">private</span> Date time;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="7-2-Mapper"><a href="#7-2-Mapper" class="headerlink" title="7.2 Mapper"></a>7.2 Mapper</h3><p>很简单，只实现一个插入方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Mapper</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TickMapper</span> </span>&#123;</div><div class="line">    <span class="meta">@Insert</span>(<span class="string">"insert into tick (id,name,exchange,ask,bid,time) values (#&#123;id&#125;,#&#123;name&#125;,#&#123;exchange&#125;,#&#123;ask&#125;,#&#123;bid&#125;,#&#123;time&#125;)"</span>)</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insertTick</span><span class="params">(Tick tick)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="7-3-SessionFactory配置"><a href="#7-3-SessionFactory配置" class="headerlink" title="7.3 SessionFactory配置"></a>7.3 SessionFactory配置</h3><p>还要设置一下tick的SessionFactory：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">@Configuration</div><div class="line">@MapperScan(basePackages = &quot;com.spartajet.shardingboot.mapper&quot;, sqlSessionFactoryRef = &quot;sessionFactory&quot;)</div><div class="line">public class TickSessionFactoryConfig &#123;</div><div class="line">    @Bean</div><div class="line">    public SqlSessionFactory sessionFactory(DataSource shardingDataSource) throws Exception &#123;</div><div class="line">        final SqlSessionFactoryBean sessionFactory = new SqlSessionFactoryBean();</div><div class="line">        sessionFactory.setDataSource(shardingDataSource);</div><div class="line">        return sessionFactory.getObject();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Bean</div><div class="line">    public CommonSelfIdGenerator commonSelfIdGenerator() &#123;</div><div class="line">        CommonSelfIdGenerator.setClock(AbstractClock.systemClock());</div><div class="line">        CommonSelfIdGenerator commonSelfIdGenerator = new CommonSelfIdGenerator();</div><div class="line">        return commonSelfIdGenerator;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里添加了一个<code>CommonSelfIdGenerator</code>，sharding自带的id生成器，看了下代码和<code>facebook</code>的<code>snowflake</code>类似。我又不想把数据库的主键设置成自增的，否则数据双向同步会死的很惨的。</p>
<p>### </p>
<h2 id="八、测试写入"><a href="#八、测试写入" class="headerlink" title="八、测试写入"></a>八、测试写入</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">@RunWith(SpringJUnit4ClassRunner.class)</div><div class="line">@SpringBootTest</div><div class="line">public class SpringbootShardingJdbcDemoApplicationTests &#123;</div><div class="line">    @Autowired</div><div class="line">    private TickMapper tickMapper;</div><div class="line">    @Autowired</div><div class="line">    private CommonSelfIdGenerator commonSelfIdGenerator;</div><div class="line">    </div><div class="line">    </div><div class="line">    @Test</div><div class="line">    public void contextLoads() &#123;</div><div class="line">        Tick tick = new Tick(commonSelfIdGenerator.generateId().longValue(), &quot;a&quot;, &quot;sh&quot;, 100, 200, new Date());</div><div class="line">        this.tickMapper.insertTick(tick);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>成功实现增量分库分表！！！</p>
]]></content>
      
        
        <tags>
            
            <tag> springboot </tag>
            
            <tag> sharding-jdbc </tag>
            
            <tag> 分库分表 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Hello World]]></title>
      <url>/2017/05/19/hello-world/</url>
      <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>
]]></content>
      
        
    </entry>
    
  
  
</search>
